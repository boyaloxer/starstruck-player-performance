<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Starstruck Player Performance Calculator</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2b;
      --accent: #6ee7ff;
      --muted: #9fb3c8;
      --danger: #ff6b6b;
      --ok: #38d39f;
      --text: #e6eef6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell,
        Helvetica, Arial, sans-serif;
      background: linear-gradient(180deg, #0b1220, #0a0f19);
      color: var(--text);
    }

    .wrap {
      max-width: 880px;
      margin: 40px auto;
      padding: 24px;
    }

    .card {
      background: var(--card);
      border: 1px solid #1d2940;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }

    .card header {
      text-align: center;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }

    p {
      color: var(--muted);
      margin: 6px 0 18px;
    }

    .grid {
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    .row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label {
      font-weight: 600;
    }

    label .metric-link {
      color: var(--text);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: color 0.2s ease, border-color 0.2s ease;
    }

    label .metric-link:hover,
    label .metric-link:focus {
      color: var(--accent);
      border-color: var(--accent);
    }

    .field label {
      display: block;
      margin-bottom: 6px;
    }

    .field {
      margin-bottom: 16px;
    }

    .reason-block {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .reason-block label {
      font-weight: 500;
      color: var(--muted);
      font-size: 13px;
    }

    input[type="number"] {
      width: 120px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a3958;
      background: #0c1425;
      color: var(--text);
      font-size: 15px;
      align-self: flex-start;
    }

    input[type="number"]:focus {
      outline: 2px solid var(--accent);
      border-color: transparent;
    }

    .reason-input {
      width: 100%;
      min-height: 64px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a3958;
      background: #0c1425;
      color: var(--text);
      font-size: 14px;
      resize: vertical;
    }

    .reason-input:focus {
      outline: 2px solid var(--accent);
      border-color: transparent;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a3958;
      background: #0c1425;
      color: var(--text);
      font-size: 15px;
    }

    input[type="text"]:focus {
      outline: 2px solid var(--accent);
      border-color: transparent;
    }

    .card header {
      text-align: center;
      margin-bottom: 18px;
    }

    .stack {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
      align-items: center;
    }

    button {
      cursor: pointer;
      border: 1px solid #2a3958;
      background: #0c1425;
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
    }

    button.primary {
      background: linear-gradient(90deg, #41b3ff, #6ee7ff);
      color: #031222;
      border: none;
    }

    .result {
      display: flex;
      gap: 16px;
      align-items: baseline;
      margin-top: 12px;
    }

    .result .score {
      font-size: 36px;
      font-weight: 900;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #2a3958;
      color: var(--muted);
    }

    .warn {
      color: var(--danger);
    }

    .ok {
      color: var(--ok);
    }

    details {
      margin-top: 18px;
    }

    summary {
      cursor: pointer;
      color: var(--accent);
    }

    .weights {
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
    }

    .formula-toggle {
      display: inline-block;
      margin-top: 10px;
    }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>Starstruck Player Performance Calculator</h1>
        <p>
          Enter 0–10 for each metric. Attendance is measured 0–100%.
        </p>
        <details class="formula-toggle">
          <summary>Show weights & formula</summary>
          <div class="weights" id="weights"></div>
        </details>
      </header>

      <div class="field">
        <label for="playerName">Player Name</label>
        <input
          id="playerName"
          type="text"
          placeholder="Enter player name"
          autocomplete="off"
        />
      </div>

      <div class="grid" id="form">
        <div class="row">
          <label for="adapt"><a class="metric-link" href="metrics.html#adaptability">Adaptability</a></label>
          <input id="adapt" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="adaptReason">Reason</label>
            <textarea
              id="adaptReason"
              class="reason-input"
              placeholder="Reason for Adaptability score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="mech"><a class="metric-link" href="metrics.html#mechanics">Mechanics Execution</a></label>
          <input id="mech" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="mechReason">Reason</label>
            <textarea
              id="mechReason"
              class="reason-input"
              placeholder="Reason for Mechanics Execution score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="class"><a class="metric-link" href="metrics.html#class-specific">Class Specific Execution</a></label>
          <input id="class" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="classReason">Reason</label>
            <textarea
              id="classReason"
              class="reason-input"
              placeholder="Reason for Class Specific Execution score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="prep"><a class="metric-link" href="metrics.html#prep">Raid Prep</a></label>
          <input id="prep" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="prepReason">Reason</label>
            <textarea
              id="prepReason"
              class="reason-input"
              placeholder="Reason for Raid Prep score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="raw"><a class="metric-link" href="metrics.html#parses">Raw Parses</a></label>
          <input id="raw" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="rawReason">Reason</label>
            <textarea
              id="rawReason"
              class="reason-input"
              placeholder="Reason for Raw Parses score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="attitude"><a class="metric-link" href="metrics.html#attitude">Attitude</a></label>
          <input id="attitude" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="attitudeReason">Reason</label>
            <textarea
              id="attitudeReason"
              class="reason-input"
              placeholder="Reason for Attitude score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="attend"><a class="metric-link" href="metrics.html#attendance">Attendance % (flag if &lt; 80%)</a></label>
          <input id="attend" type="number" min="0" max="100" step="1" value="100" />
        </div>
      </div>

      <div class="stack">
        <button id="downloadPdf">Download PDF</button>
      </div>

      <div class="result">
        <div>Total:</div>
        <div class="score" id="total">10.00</div>
        <div class="pill" id="outOf100">100.00 / 100</div>
        <div id="attnFlag" class="pill"></div>
      </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script>
    const weights = {
      adapt: 0.3,
      mech: 0.25,
      class: 0.2,
      prep: 0.1,
      raw: 0.05,
      attitude: 0.05,
    };

    const metricMeta = [
      { id: "adapt", label: "Adaptability", reason: "adaptReason" },
      { id: "mech", label: "Mechanics Execution", reason: "mechReason" },
      { id: "class", label: "Class Specific Execution", reason: "classReason" },
      { id: "prep", label: "Raid Prep", reason: "prepReason" },
      { id: "raw", label: "Raw Parses", reason: "rawReason" },
      { id: "attitude", label: "Attitude", reason: "attitudeReason" },
    ];

    const metricIds = metricMeta.map((meta) => meta.id);
    const reasonIds = metricMeta.map((meta) => meta.reason);
    const activeWeightSum = Object.values(weights).reduce(
      (acc, value) => acc + value,
      0,
    );

    function clamp(value, min, max) {
      const num = Number(value);
      if (!Number.isFinite(num)) {
        return 0;
      }
      return Math.max(min, Math.min(max, num));
    }

    function calc() {
      const get = (id) => document.getElementById(id);

      metricIds.forEach((id) => {
        const element = get(id);
        element.value = clamp(element.value, 0, 10);
      });

      const attendance = clamp(get("attend").value, 0, 100);

      let sum = 0;
      for (const [id, weight] of Object.entries(weights)) {
        sum += Number(get(id).value) * weight;
      }

      const total10 = sum / activeWeightSum;
      const total100 = total10 * 10;

      const flag = get("attnFlag");
      if (attendance < 80) {
        flag.textContent = `ATTENDANCE: ${attendance.toFixed(0)}% (FLAG)`;
        flag.className = "pill warn";
        get("total").textContent = "0.00";
        get("outOf100").textContent = "0.00 / 100";
        return;
      }

      flag.textContent = `Attendance OK: ${attendance.toFixed(0)}%`;
      flag.className = "pill ok";

      get("total").textContent = total10.toFixed(2);
      get("outOf100").textContent = `${total100.toFixed(2)} / 100`;

      const names = {
        adapt: "Adaptability",
        mech: "Mechanics Execution",
        class: "Class Specific Execution",
        prep: "Raid Prep",
        raw: "Raw Parses",
        attitude: "Attitude",
      };

      const weightLines = Object.entries(weights)
        .map(([key, value]) => `${names[key]} — ${(value * 100).toFixed(0)}%`)
        .join("<br>");

      const normalized = `Active Weight Sum = ${(activeWeightSum * 100).toFixed(0)}% (normalized)`;
      get("weights").innerHTML = `${weightLines}<br>${normalized}`;
    }

    document
      .getElementById("downloadPdf")
      .addEventListener("click", handleDownloadPdf);

    function handleDownloadPdf() {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        console.error("jsPDF failed to load; falling back to print.");
        window.print();
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "letter" });
      const marginX = 54;
      const pageWidth = doc.internal.pageSize.getWidth();
      const contentWidth = pageWidth - marginX * 2;
      const pageHeight = doc.internal.pageSize.getHeight();
      let cursorY = 96;

      const colors = {
        background: [11, 18, 32],
        card: [17, 26, 43],
        accent: [110, 231, 255],
        text: [230, 238, 246],
        muted: [178, 195, 215],
        border: [38, 58, 88],
        tableHead: [25, 38, 62],
        tableRow: [17, 26, 43],
        tableRowAlt: [21, 32, 50],
        pillBg: [13, 22, 39],
      };

      const originalAddPage = doc.addPage.bind(doc);
      doc.addPage = function (...args) {
        const result = originalAddPage(...args);
        const width = this.internal.pageSize.getWidth();
        const height = this.internal.pageSize.getHeight();
        this.setFillColor(...colors.background);
        this.rect(0, 0, width, height, "F");
        return result;
      };

      doc.setFillColor(...colors.background);
      doc.rect(0, 0, pageWidth, pageHeight, "F");

      const getValue = (value, fallback = "—") =>
        value && value.toString().trim().length > 0 ? value.toString().trim() : fallback;

      const playerRaw = getValue(document.getElementById("playerName").value, "—");
      const attendance = Number(document.getElementById("attend").value || 0);
      const attendanceStatus = getValue(
        document.getElementById("attnFlag").textContent,
        "—",
      );
      const totalScore = getValue(document.getElementById("total").textContent, "0.00");
      const total100 = getValue(document.getElementById("outOf100").textContent, "0.00 / 100");
      const generatedStamp = new Date().toLocaleString();

      const metricRows = metricMeta.map((meta) => {
        const scoreValue = Number(document.getElementById(meta.id).value);
        const reasonRaw = getValue(
          document.getElementById(meta.reason).value,
          "—",
        );
        return [
          meta.label,
          scoreValue.toFixed(2),
          reasonRaw.replace(/\r\n/g, "\n"),
        ];
      });

      const weightRows = Object.entries(weights).map(([key, value]) => {
        const label = metricMeta.find((meta) => meta.id === key)?.label || key;
        return [label, `${(value * 100).toFixed(0)}%`];
      });

      doc.setFont("helvetica", "bold");
      doc.setFontSize(20);
      doc.setTextColor(...colors.text);
      doc.text("Starstruck Player Performance Review", pageWidth / 2, cursorY, {
        align: "center",
      });

      cursorY += 18;
      doc.setFontSize(11);
      doc.setTextColor(...colors.text);

      cursorY += 34;
      const summaryHeight = 64;
      doc.setDrawColor(...colors.border);
      doc.setFillColor(...colors.card);
      doc.roundedRect(marginX, cursorY - 44, contentWidth, summaryHeight, 10, 10, "DF");

      const summaryItems = [
        { label: "Player", value: playerRaw },
        { label: "Overall Performance (0 - 10)", value: totalScore },
        { label: "Report Generated", value: generatedStamp },
      ];

      const summaryColumnWidth = contentWidth / summaryItems.length;
      summaryItems.forEach((entry, index) => {
        const columnX = marginX + index * summaryColumnWidth + summaryColumnWidth / 2;
        doc.setFont("helvetica", "bold");
        doc.setTextColor(...colors.accent);
        doc.text(entry.label, columnX, cursorY - 18, { align: "center" });
        doc.setFont("helvetica", "normal");
        doc.setTextColor(...colors.text);
        doc.text(entry.value, columnX, cursorY + 4, { align: "center" });
      });

      cursorY += summaryHeight + 18;

      const metaLineY = cursorY;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(11);
      doc.setTextColor(...colors.accent);
      doc.text("Attendance:", marginX, metaLineY);
      doc.setFont("helvetica", "normal");
      doc.setTextColor(...colors.text);
      doc.text(`${attendance.toFixed(0)}%`, marginX + 76, metaLineY);

      doc.setFont("helvetica", "bold");
      doc.setTextColor(...colors.accent);
      const statusX = marginX + contentWidth / 2;
      doc.text("Status:", statusX, metaLineY);
      doc.setFont("helvetica", "normal");
      doc.setTextColor(...colors.text);
      doc.text(attendanceStatus, statusX + 52, metaLineY);

      cursorY += 26;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.setTextColor(...colors.text);
      doc.text("Metric Breakdown", marginX, cursorY);

      cursorY += 8;
      doc.autoTable({
        startY: cursorY,
        head: [["Metric", "Score (0 - 10)", "Reasoning / Notes"]],
        body: metricRows,
        margin: { left: marginX, right: marginX },
        headStyles: {
          fillColor: colors.tableHead,
          textColor: colors.text,
          fontSize: 11,
        },
        styles: {
          font: "helvetica",
          fontSize: 10,
          cellPadding: { top: 6, right: 6, bottom: 6, left: 6 },
          lineColor: colors.border,
          lineWidth: 0.6,
          textColor: colors.text,
          fillColor: colors.tableRow,
        },
        alternateRowStyles: {
          fillColor: colors.tableRowAlt,
        },
        columnStyles: {
          1: { halign: "center", cellWidth: 90 },
          2: { cellWidth: contentWidth - 90 - 120 },
        },
        didDrawPage: (data) => {
          doc.setFontSize(10);
          doc.setTextColor(...colors.muted);
          doc.text(
            `Starstruck Player Performance · Generated ${generatedStamp}`,
            marginX,
            doc.internal.pageSize.getHeight() - 30,
          );
        },
      });

      let tableBottom = doc.lastAutoTable.finalY;
      if (tableBottom === undefined) {
        tableBottom = cursorY + 20;
      }

      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.setTextColor(...colors.text);
      doc.text("Weight Reference", marginX, tableBottom + 26);

      doc.autoTable({
        startY: tableBottom + 34,
        head: [["Metric", "Weight"]],
        body: weightRows,
        margin: { left: marginX, right: marginX },
        headStyles: {
          fillColor: colors.tableHead,
          textColor: colors.text,
          fontSize: 11,
        },
        styles: {
          font: "helvetica",
          fontSize: 10,
          cellPadding: { top: 6, right: 6, bottom: 6, left: 6 },
          lineColor: colors.border,
          lineWidth: 0.6,
          textColor: colors.text,
          fillColor: colors.tableRow,
        },
        alternateRowStyles: {
          fillColor: colors.tableRowAlt,
        },
        columnStyles: {
          1: { halign: "center" },
        },
      });

      const filenameBase = playerRaw
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-|-$/g, "");

      doc.save(`${filenameBase || "player-review"}.pdf`);
    }

    function bindInputs() {
      const attendanceInput = document.getElementById("attend");
      const fieldInputs = metricIds
        .map((id) => document.getElementById(id))
        .concat(attendanceInput);

      fieldInputs.forEach((input) => {
        ["input", "change"].forEach((evt) => input.addEventListener(evt, calc));
      });
    }

    function initializeDefaults() {
      metricIds.forEach((id) => {
        document.getElementById(id).value = 10;
      });
      document.getElementById("attend").value = 100;
      reasonIds.forEach((id) => {
        document.getElementById(id).value = "";
      });
    }

    bindInputs();
    initializeDefaults();
    calc();
  </script>
</body>
</html>

