<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Starstruck Player Performance Calculator</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2b;
      --accent: #6ee7ff;
      --muted: #9fb3c8;
      --danger: #ff6b6b;
      --ok: #38d39f;
      --text: #e6eef6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell,
        Helvetica, Arial, sans-serif;
      background: linear-gradient(180deg, #0b1220, #0a0f19);
      color: var(--text);
    }

    .wrap {
      max-width: 880px;
      margin: 40px auto;
      padding: 24px;
    }

    .card {
      background: var(--card);
      border: 1px solid #1d2940;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }

    .card header {
      text-align: center;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }

    p {
      color: var(--muted);
      margin: 6px 0 18px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 12px;
      align-items: center;
    }

    .row {
      display: contents;
    }

    label {
      font-weight: 600;
    }

    .field label {
      display: block;
      margin-bottom: 6px;
    }

    .field {
      margin-bottom: 16px;
    }

    .reason-block {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .reason-block label {
      font-weight: 500;
      color: var(--muted);
      font-size: 13px;
    }

    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a3958;
      background: #0c1425;
      color: var(--text);
      font-size: 15px;
    }

    input[type="number"]:focus {
      outline: 2px solid var(--accent);
      border-color: transparent;
    }

    .reason-input {
      width: 100%;
      min-height: 64px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a3958;
      background: #0c1425;
      color: var(--text);
      font-size: 14px;
      resize: vertical;
    }

    .reason-input:focus {
      outline: 2px solid var(--accent);
      border-color: transparent;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a3958;
      background: #0c1425;
      color: var(--text);
      font-size: 15px;
    }

    input[type="text"]:focus {
      outline: 2px solid var(--accent);
      border-color: transparent;
    }

    .stack {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
      align-items: center;
    }

    button {
      cursor: pointer;
      border: 1px solid #2a3958;
      background: #0c1425;
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
    }

    button.primary {
      background: linear-gradient(90deg, #41b3ff, #6ee7ff);
      color: #031222;
      border: none;
    }

    .result {
      display: flex;
      gap: 16px;
      align-items: baseline;
      margin-top: 12px;
    }

    .result .score {
      font-size: 36px;
      font-weight: 900;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #2a3958;
      color: var(--muted);
    }

    .warn {
      color: var(--danger);
    }

    .ok {
      color: var(--ok);
    }

    details {
      margin-top: 18px;
    }

    summary {
      cursor: pointer;
      color: var(--accent);
    }

    .weights {
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
    }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>Starstruck Player Performance Calculator</h1>
        <p>
          Enter 0–10 for each metric. Attendance is measured 0–100%.
        </p>
      </header>

      <div class="field">
        <label for="playerName">Player Name</label>
        <input
          id="playerName"
          type="text"
          placeholder="Enter player name"
          autocomplete="off"
        />
      </div>

      <div class="grid" id="form">
        <div class="row">
          <label for="adapt">Adaptability</label>
          <input id="adapt" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="adaptReason">Reason</label>
            <textarea
              id="adaptReason"
              class="reason-input"
              placeholder="Reason for Adaptability score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="mech">Mechanics Execution</label>
          <input id="mech" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="mechReason">Reason</label>
            <textarea
              id="mechReason"
              class="reason-input"
              placeholder="Reason for Mechanics Execution score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="class">Class Specific Execution</label>
          <input id="class" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="classReason">Reason</label>
            <textarea
              id="classReason"
              class="reason-input"
              placeholder="Reason for Class Specific Execution score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="prep">Raid Prep</label>
          <input id="prep" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="prepReason">Reason</label>
            <textarea
              id="prepReason"
              class="reason-input"
              placeholder="Reason for Raid Prep score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="raw">Raw Parses</label>
          <input id="raw" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="rawReason">Reason</label>
            <textarea
              id="rawReason"
              class="reason-input"
              placeholder="Reason for Raw Parses score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="attitude">Attitude</label>
          <input id="attitude" type="number" min="0" max="10" step="0.1" value="10" />
          <div class="reason-block">
            <label for="attitudeReason">Reason</label>
            <textarea
              id="attitudeReason"
              class="reason-input"
              placeholder="Reason for Attitude score"
            ></textarea>
          </div>
        </div>
        <div class="row">
          <label for="attend">Attendance % (flag if &lt; 80%)</label>
          <input id="attend" type="number" min="0" max="100" step="1" value="100" />
        </div>
      </div>

      <div class="stack">
        <button id="reset">Reset to 10s</button>
        <button id="downloadPdf">Download PDF</button>
      </div>

      <div class="result">
        <div>Total:</div>
        <div class="score" id="total">10.00</div>
        <div class="pill" id="outOf100">100.00 / 100</div>
        <div id="attnFlag" class="pill"></div>
      </div>

      <details>
        <summary>Show weights & formula</summary>
        <div class="weights" id="weights"></div>
      </details>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    const weights = {
      adapt: 0.3,
      mech: 0.25,
      class: 0.2,
      prep: 0.1,
      raw: 0.05,
      attitude: 0.05,
    };

    const metricMeta = [
      { id: "adapt", label: "Adaptability", reason: "adaptReason" },
      { id: "mech", label: "Mechanics Execution", reason: "mechReason" },
      { id: "class", label: "Class Specific Execution", reason: "classReason" },
      { id: "prep", label: "Raid Prep", reason: "prepReason" },
      { id: "raw", label: "Raw Parses", reason: "rawReason" },
      { id: "attitude", label: "Attitude", reason: "attitudeReason" },
    ];

    const metricIds = metricMeta.map((meta) => meta.id);
    const reasonIds = metricMeta.map((meta) => meta.reason);
    const activeWeightSum = Object.values(weights).reduce(
      (acc, value) => acc + value,
      0,
    );

    function clamp(value, min, max) {
      const num = Number(value);
      if (!Number.isFinite(num)) {
        return 0;
      }
      return Math.max(min, Math.min(max, num));
    }

    function calc() {
      const get = (id) => document.getElementById(id);

      metricIds.forEach((id) => {
        const element = get(id);
        element.value = clamp(element.value, 0, 10);
      });

      const attendance = clamp(get("attend").value, 0, 100);

      let sum = 0;
      for (const [id, weight] of Object.entries(weights)) {
        sum += Number(get(id).value) * weight;
      }

      const total10 = sum / activeWeightSum;
      const total100 = total10 * 10;

      const flag = get("attnFlag");
      if (attendance < 80) {
        flag.textContent = `ATTENDANCE: ${attendance.toFixed(0)}% (FLAG)`;
        flag.className = "pill warn";
        get("total").textContent = "0.00";
        get("outOf100").textContent = "0.00 / 100";
        return;
      }

      flag.textContent = `Attendance OK: ${attendance.toFixed(0)}%`;
      flag.className = "pill ok";

      get("total").textContent = total10.toFixed(2);
      get("outOf100").textContent = `${total100.toFixed(2)} / 100`;

      const names = {
        adapt: "Adaptability",
        mech: "Mechanics Execution",
        class: "Class Specific Execution",
        prep: "Raid Prep",
        raw: "Raw Parses",
        attitude: "Attitude",
      };

      const weightLines = Object.entries(weights)
        .map(([key, value]) => `${names[key]} — ${(value * 100).toFixed(0)}%`)
        .join("<br>");

      const normalized = `Active Weight Sum = ${(activeWeightSum * 100).toFixed(0)}% (normalized)`;
      get("weights").innerHTML = `${weightLines}<br>${normalized}`;
    }

    document.getElementById("reset").addEventListener("click", () => {
      metricMeta.forEach((meta) => {
        document.getElementById(meta.id).value = 10;
      });
      document.getElementById("attend").value = 100;
      document.querySelectorAll(".reason-input").forEach((element) => {
        element.value = "";
      });
      calc();
    });

    document
      .getElementById("downloadPdf")
      .addEventListener("click", handleDownloadPdf);

    function escapeHtml(raw) {
      return raw
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function handleDownloadPdf() {
      const playerRaw = document.getElementById("playerName").value.trim();
      const attendance = Number(document.getElementById("attend").value || 0);
      const attendanceStatus = document.getElementById("attnFlag").textContent;
      const totalScore = document.getElementById("total").textContent;
      const total100 = document.getElementById("outOf100").textContent;
      const generatedStamp = new Date().toLocaleString();

      const rows = metricMeta
        .map((meta) => {
          const scoreValue = Number(document.getElementById(meta.id).value);
          const reasonRaw = document.getElementById(meta.reason).value.trim();
          const reason =
            reasonRaw.length > 0
              ? escapeHtml(reasonRaw).replace(/\n/g, "<br>")
              : "—";
          return `
            <tr>
              <td>${meta.label}</td>
              <td>${scoreValue.toFixed(2)}</td>
              <td>${reason}</td>
            </tr>`;
        })
        .join("");

      const weightRows = Object.entries(weights)
        .map(([key, value]) => {
          const label = metricMeta.find((meta) => meta.id === key)?.label || key;
          return `
            <tr>
              <td>${label}</td>
              <td>${(value * 100).toFixed(0)}%</td>
            </tr>`;
        })
        .join("");

      const pdfShell = document.createElement("div");
      pdfShell.style.position = "fixed";
      pdfShell.style.left = "-10000px";
      pdfShell.style.top = "0";
      pdfShell.style.width = "720px"; /* (8.5in - 2*0.5in) at 96dpi */
      pdfShell.innerHTML = `
        <style>
          * { box-sizing: border-box; }
          body { font-family: "Segoe UI", Arial, sans-serif; color: #1a1f2b; margin: 0; }
          h1 { font-size: 24px; margin: 0 0 6px; color: #0c1a33; }
          h2 { font-size: 16px; margin: 18px 0 8px; color: #0c1a33; }
          table { width: 100%; border-collapse: collapse; margin-top: 8px; page-break-inside: avoid; }
          thead { display: table-header-group; }
          th, td { border: 1px solid #d3dbe7; padding: 9px 10px; font-size: 13px; vertical-align: top; }
          th { background: #eef3fb; text-align: left; font-weight: 600; }
          .layout { padding: 28px 32px; }
          .meta { display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; margin: 10px 0 4px; }
          .meta div { min-width: 180px; }
          .summary { display: flex; flex-wrap: wrap; gap: 16px; background: #f7f9fc; border: 1px solid #d3dbe7; padding: 14px 16px; border-radius: 10px; font-size: 13px; }
          .summary div { min-width: 160px; }
          .weights { margin-top: 4px; }
          .generated { margin-top: 12px; font-size: 12px; color: #52607a; }
        </style>
        <div class="layout">
          <h1>Starstruck Player Performance Review</h1>
          <div class="meta">
            <div><strong>Player:</strong> ${playerRaw ? escapeHtml(playerRaw) : "—"}</div>
            <div><strong>Attendance:</strong> ${attendance.toFixed(0)}%</div>
            <div><strong>Status:</strong> ${escapeHtml(attendanceStatus || "—")}</div>
          </div>
          <div class="summary">
            <div><strong>Total (0 – 10):</strong> ${totalScore}</div>
            <div><strong>Total (0 – 100):</strong> ${total100}</div>
            <div><strong>Report Generated:</strong> ${escapeHtml(generatedStamp)}</div>
          </div>
          <h2>Metric Breakdown</h2>
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th>Score (0 – 10)</th>
                <th>Reasoning / Notes</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
          <h2>Weight Reference</h2>
          <table class="weights">
            <thead>
              <tr>
                <th>Metric</th>
                <th>Weight</th>
              </tr>
            </thead>
            <tbody>${weightRows}</tbody>
          </table>
          <div class="generated">Generated for Starstruck leadership review.</div>
        </div>`;

      const filenameBase = playerRaw
        ? playerRaw.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "")
        : "player-review";

      const options = {
        margin: 0.5,
        filename: `${filenameBase || "player-review"}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
      };

      if (typeof html2pdf !== "function") {
        console.warn("html2pdf failed to load; falling back to browser print.");
        window.print();
        return;
      }

      document.body.appendChild(pdfShell);
      html2pdf()
        .set(options)
        .from(pdfShell)
        .save()
        .then(() => {
          document.body.removeChild(pdfShell);
        })
        .catch((err) => {
          document.body.removeChild(pdfShell);
          console.error("Failed to generate PDF:", err);
          window.print();
        });
    }

    function bindInputs() {
      const attendanceInput = document.getElementById("attend");
      const fieldInputs = metricIds
        .map((id) => document.getElementById(id))
        .concat(attendanceInput);

      fieldInputs.forEach((input) => {
        ["input", "change"].forEach((evt) => input.addEventListener(evt, calc));
      });
    }

    function initializeDefaults() {
      metricIds.forEach((id) => {
        document.getElementById(id).value = 10;
      });
      document.getElementById("attend").value = 100;
      reasonIds.forEach((id) => {
        document.getElementById(id).value = "";
      });
    }

    bindInputs();
    initializeDefaults();
    calc();
  </script>
</body>
</html>

